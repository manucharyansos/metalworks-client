(window.webpackJsonp=window.webpackJsonp||[]).push([[3,30],{616:function(e,t,r){"use strict";r.r(t);var n=r(1),o=(r(9),r(33),r(49),r(17),r(403),r(582),r(27),r(8),r(598),r(30),r(570)),l=r(589),c=r(597),d=r(645),f={name:"DxfCanvasViewer",props:{dxfUrl:{type:String,required:!0},fileMeta:{type:Object,default:null},showLaserInfo:{type:Boolean,default:!0}},data:function(){return{scene:null,camera:null,renderer:null,controls:null,dxfGroup:null,error:null,raf:null,laserLengthMm:0}},computed:{laserLengthMmRounded:function(){return this.laserLengthMm?Number(this.laserLengthMm.toFixed(1)):0},materialInfo:function(){if(!this.fileMeta)return"";var e=this.fileMeta.material_type||this.fileMeta.material||this.fileMeta.materialType||"",th=this.fileMeta.thickness||"";return e&&th?"".concat(e," (").concat(th,")"):e||th||""}},watch:{dxfUrl:function(){this.loadDxfFile()}},mounted:function(){this.initThree(),this.loadDxfFile(),window.addEventListener("resize",this.onResize)},beforeDestroy:function(){window.removeEventListener("resize",this.onResize),this.cleanupThree()},methods:{initThree:function(){var e=this,canvas=this.$refs.canvas,t=canvas.clientWidth||960,r=canvas.clientHeight||600;this.scene=new o.ld,this.camera=new o.lc(60,t/r,.1,5e4),this.camera.position.set(0,0,500),this.renderer=new l.a({canvas:canvas,antialias:!0}),this.renderer.setClearColor(16777215,1),this.renderer.setPixelRatio(window.devicePixelRatio||1),this.renderer.setSize(t,r,!1),this.controls=new d.a(this.camera,canvas),this.controls.enableDamping=!0,this.controls.dampingFactor=.08,this.scene.add(new o.i(16777215,1));var n=function(){e.raf=requestAnimationFrame(n),e.controls.update(),e.renderer.render(e.scene,e.camera)};n()},onResize:function(){if(this.renderer&&this.camera){var canvas=this.$refs.canvas,e=canvas.clientWidth||960,t=canvas.clientHeight||600;this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t,!1)}},cleanupThree:function(){var e,t,r,n;this.raf&&cancelAnimationFrame(this.raf),null===(e=this.controls)||void 0===e||null===(t=e.dispose)||void 0===t||t.call(e),null===(r=this.renderer)||void 0===r||null===(n=r.dispose)||void 0===n||n.call(r),this.dxfGroup&&this.dxfGroup.traverse(function(e){var t,r,n,o;null===(t=e.geometry)||void 0===t||null===(r=t.dispose)||void 0===r||r.call(t),Array.isArray(e.material)?e.material.forEach(function(e){var t;return null==e||null===(t=e.dispose)||void 0===t?void 0:t.call(e)}):null===(n=e.material)||void 0===n||null===(o=n.dispose)||void 0===o||o.call(n)}),this.scene=this.camera=this.renderer=this.controls=this.dxfGroup=null,this.laserLengthMm=0},loadDxfFile:function(){var e=this;return Object(n.a)(regeneratorRuntime.mark(function t(){var r,data,n,o,l,c;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,e.error=null,e.cleanupThree(),e.initThree(),e.laserLengthMm=0,t.next=1,e.$axios.get("/api/factories/getFile/".concat(e.dxfUrl));case 1:if(r=t.sent,data=r.data,200===(n=r.status)){t.next=2;break}throw new Error("HTTP ".concat(n));case 2:o=atob(data.content);try{l=JSON.parse(o),o=null!=l&&l.content?atob(l.content):o}catch(e){}e.parseDxf(o),t.next=4;break;case 3:t.prev=3,c=t.catch(0),console.error(c),e.error=c.message||"Չհաջողվեց բեռնել DXF-ը",e.$notify({text:e.error,type:"error",duration:4e3});case 4:case"end":return t.stop()}},t,null,[[0,3]])}))()},parseDxf:function(e){var t=this;try{var r,n=(new c.a).parseSync(e);this.dxfGroup&&this.scene.remove(this.dxfGroup),this.dxfGroup=new o.hb,this.laserLengthMm=0;var l=new o.qb({color:0}),d=new o.qb({color:1982639}),f=function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t.dxfGroup,c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;try{var h,v;if("LINE"===e.type){var m,x,w=(null===(m=e.vertices)||void 0===m?void 0:m[0])||e.start,y=(null===(x=e.vertices)||void 0===x?void 0:x[1])||e.end;if(!w||!y)return;var _=new o.Jd(w.x,w.y,0),C=new o.Jd(y.x,y.y,0),k=(new o.p).setFromPoints([_,C]);r.add(new o.pb(k,l)),t.laserLengthMm+=_.distanceTo(C)*c}else if("LWPOLYLINE"===e.type||"POLYLINE"===e.type){if(!e.vertices||e.vertices.length<2)return;var F=e.vertices.map(function(e){return new o.Jd(e.x,e.y,0)});(e.closed||e.shape)&&F.push(F[0]);var P=(new o.p).setFromPoints(F);r.add(new o.pb(P,l));for(var i=1;i<F.length;i++)t.laserLengthMm+=F[i].distanceTo(F[i-1])*c}else if("CIRCLE"===e.type){var D=new o.t(e.radius,64);D.translate(e.center.x,e.center.y,0);var M=new o.R(D);r.add(new o.rb(M,l)),t.laserLengthMm+=2*Math.PI*e.radius*c}else if("ARC"===e.type){var O=o.Bb.degToRad(e.startAngle),L=o.Bb.degToRad(e.endAngle),j=new o.j(e.center.x,e.center.y,e.radius,O,L,L<O).getPoints(64).map(function(p){return new o.Jd(p.x,p.y,0)}),E=(new o.p).setFromPoints(j);r.add(new o.pb(E,l));for(var R=1;R<j.length;R++)t.laserLengthMm+=j[R].distanceTo(j[R-1])*c}else if("SPLINE"===e.type&&(null===(h=e.controlPoints)||void 0===h?void 0:h.length)>=2){var S=e.controlPoints.map(function(p){return new o.Jd(p.x,p.y,0)}),T=new o.r(S);T.tension=.5;var I=T.getPoints(100),$=(new o.p).setFromPoints(I);r.add(new o.pb($,d));for(var G=1;G<I.length;G++)t.laserLengthMm+=I[G].distanceTo(I[G-1])*c}else if("ELLIPSE"===e.type){var A=new o.S(e.center.x,e.center.y,e.majorRadius,e.minorRadius,e.startAngle||0,e.endAngle||2*Math.PI,!1,0).getPoints(100).map(function(p){return new o.Jd(p.x,p.y,0)}),z=(new o.p).setFromPoints(A);r.add(new o.pb(z,l));for(var J=1;J<A.length;J++)t.laserLengthMm+=A[J].distanceTo(A[J-1])*c}else if("INSERT"===e.type&&null!==(v=n.blocks)&&void 0!==v&&v[e.name]){var U,N,H,X=n.blocks[e.name],B=new o.hb,V=(null===(U=e.scale)||void 0===U?void 0:U.x)||e.xScale||1,W=(null===(N=e.scale)||void 0===N?void 0:N.y)||e.yScale||1,s=(V+W)/2||1;null===(H=X.entities)||void 0===H||H.forEach(function(e){return f(e,B,c*s)}),e.position&&B.position.set(e.position.x,e.position.y,0),e.rotation&&(B.rotation.z=o.Bb.degToRad(e.rotation)),B.scale.set(V||1,W||1,1),r.add(B)}}catch(t){console.warn("Entity error:",e.type,t)}};if(null===(r=n.entities)||void 0===r||r.forEach(function(e){return f(e)}),0===this.dxfGroup.children.length){var h,v,m,x=(null===(h=n.blocks)||void 0===h?void 0:h["*Model_Space"])||(null===(v=n.blocks)||void 0===v?void 0:v["*Paper_Space"]);null==x||null===(m=x.entities)||void 0===m||m.forEach(function(e){return f(e)})}if(this.scene.add(this.dxfGroup),this.dxfGroup.children.length>0){var w=(new o.m).setFromObject(this.dxfGroup),y=w.getCenter(new o.Jd),_=w.getSize(new o.Jd);this.dxfGroup.position.sub(y);var C=(Math.max(_.x,_.y)||100)/(2*Math.tan(this.camera.fov*Math.PI/180/2))*1.4;this.camera.position.set(0,0,Math.max(C,50)),this.camera.lookAt(0,0,0),this.controls.target.set(0,0,0),this.controls.update()}else this.error="DXF-ը դատարկ է կամ չի պարունակում գծագրեր"}catch(e){console.error("DXF parse error:",e),this.error=e.message||"DXF-ը չի կարող մշակվել",this.$notify({text:this.error,type:"error",duration:5e3})}}}},h=f,v=r(32),component=Object(v.a)(h,function(){var e=this,t=e._self._c;return t("div",{staticClass:"w-full h-full relative"},[t("button",{staticClass:"absolute top-3 right-3 flex items-center justify-center rounded-lg text-sm transition",on:{click:function(t){return e.$emit("close")}}},[t("svg",{staticClass:"hover:animate-pulse",attrs:{xmlns:"http://www.w3.org/2000/svg",x:"0px",y:"0px",width:"30",height:"30",viewBox:"0 0 48 48"}},[t("path",{attrs:{fill:"#F44336",d:"M21.5 4.5H26.501V43.5H21.5z",transform:"rotate(45.001 24 24)"}}),e._v(" "),t("path",{attrs:{fill:"#F44336",d:"M21.5 4.5H26.5V43.501H21.5z",transform:"rotate(135.008 24 24)"}})])]),e._v(" "),t("canvas",{ref:"canvas",staticClass:"w-full h-full block"}),e._v(" "),e.showLaserInfo&&e.laserLengthMmRounded>0?t("div",{staticClass:"absolute left-2 top-2 px-3 py-1.5 rounded-lg bg-black/70 text-[11px] text-white backdrop-blur-sm flex flex-col gap-0.5 max-w-[280px]"},[e.materialInfo?t("div",{staticClass:"font-medium truncate"},[e._v("\n      "+e._s(e.materialInfo)+"\n    ")]):e._e(),e._v(" "),t("div",{staticClass:"opacity-80"},[e._v("\n      Գծամետրում՝\n      "),t("span",{staticClass:"font-semibold"},[e._v(e._s(e.laserLengthMmRounded))]),e._v("\n      մմ\n    ")])]):e._e(),e._v(" "),e.error?t("div",{staticClass:"absolute left-2 bottom-2 px-2 py-1 text-xs rounded bg-red-600 text-white"},[e._v("\n    DXF սխալ — "+e._s(e.error)+"\n  ")]):e._e(),e._v(" "),t("notifications")],1)},[],!1,null,null,null);t.default=component.exports},712:function(e,t,r){"use strict";r.r(t);var n=r(1),o=r(15),l=(r(9),r(33),r(23),r(24),r(39),r(40),r(27),r(8),r(30),r(18),r(186),r(61),r(96));function c(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function d(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?c(Object(r),!0).forEach(function(t){Object(o.a)(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):c(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}var f={name:"FileGallery",components:{DxfViewerModal:r(616).default},props:{items:{type:Array,default:function(){return[]}}},data:function(){return{showDxf:!1,encodedDxfPath:null,currentDxfName:null}},computed:{images:function(){var e=this;return this.items.filter(function(t){return e.hasExt(t,[".jpg",".jpeg",".png",".webp",".gif"])})},pdfs:function(){var e=this;return this.items.filter(function(t){return e.hasExt(t,[".pdf"])})},dxfFiles:function(){var e=this;return this.items.filter(function(t){return e.hasExt(t,[".dxf"])})},cadFiles:function(){var e=this;return this.items.filter(function(t){return e.hasExt(t,[".step",".stp",".sldprt",".sldasm",".igs",".iges",".dwg",".dwt"])})}},methods:d(d({},Object(l.b)("factory",["downloadUploadedFile"])),{},{keyOf:function(e){return e.id||"".concat(e.path,"-").concat(e.original_name)},filePreviewUrl:function(e,t){if(!e||"string"!=typeof e)return null;var r=this.$axios.defaults.baseURL;return"".concat(r,"/storage/").concat(e)},hasExt:function(e,t){var p=((null==e?void 0:e.path)||"").toLowerCase(),r=((null==e?void 0:e.original_name)||"").toLowerCase();return t.some(function(e){return p.endsWith(e)||r.endsWith(e)})},downloadFile:function(e){var t=this;return Object(n.a)(regeneratorRuntime.mark(function r(){var n,o,l;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:if(r.prev=0,e&&"string"==typeof e.path){r.next=1;break}return null===(n=t.$notify)||void 0===n||n.call(t,{text:"Ֆայլի ներբեռնումը ձախողվեց",duration:3e3,speed:1e3,position:"top",type:"error"}),r.abrupt("return");case 1:return o=String(e.path).replace(/\\/g,"/"),r.next=2,t.downloadUploadedFile({path:o,original_name:e.original_name||"downloaded_file"});case 2:r.next=4;break;case 3:r.prev=3,l=r.catch(0),t.$notify({text:l,duration:3e3,speed:1e3,position:"top",type:"error"});case 4:case"end":return r.stop()}},r,null,[[0,3]])}))()},openDxf:function(e){this.encodedDxfPath=String(e.path).replace(/\\/g,"/"),this.currentDxfName=(null==e?void 0:e.original_name)||"DXF",this.showDxf=!0}})},h=r(32),component=Object(h.a)(f,function(){var e=this,t=e._self._c;return t("div",{staticClass:"w-full flex flex-col space-y-6 my-2"},[e.dxfFiles.length?t("section",[t("h4",{staticClass:"text-sm font-semibold mb-2"},[e._v("DXF Files")]),e._v(" "),t("div",{staticClass:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"},e._l(e.dxfFiles,function(r){return t("div",{key:e.keyOf(r),staticClass:"rounded-xl border border-gray-200 dark:border-gray-800 p-4 bg-gray-50 dark:bg-gray-800/40"},[t("div",{staticClass:"text-sm font-medium truncate mb-2"},[e._v("\n          "+e._s(r.original_name)+"\n        ")]),e._v(" "),t("div",{staticClass:"flex items-center gap-2"},[e.$can("pmp_files.upload")?t("button",{staticClass:"flex-1 h-10 rounded-lg bg-gray-900 text-white dark:bg-gray-700 hover:bg-black/80 transition",on:{click:function(t){return e.downloadFile(r)}}},[e._v("\n            Ներբեռնել\n          ")]):e._e(),e._v(" "),e.$can("pmp_files.view")?t("button",{staticClass:"flex-1 h-10 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition",on:{click:function(t){return e.openDxf(r)}}},[e._v("\n            Դիտել\n          ")]):e._e()])])}),0)]):e._e(),e._v(" "),e.pdfs.length?t("section",[t("h4",{staticClass:"text-sm font-semibold mb-2"},[e._v("PDF Files")]),e._v(" "),t("div",{staticClass:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"},e._l(e.pdfs,function(r){return t("div",{key:e.keyOf(r),staticClass:"rounded-xl border border-gray-200 dark:border-gray-800 p-3 overflow-hidden"},[t("div",{staticClass:"h-48 rounded-lg overflow-hidden bg-gray-100 dark:bg-gray-800"},[t("embed",{staticClass:"w-full h-full",attrs:{src:e.filePreviewUrl(r.path,r.original_name),type:"application/pdf"}})]),e._v(" "),t("div",{staticClass:"mt-2 flex items-center justify-between gap-2"},[t("div",{staticClass:"text-xs truncate"},[e._v(e._s(r.original_name))]),e._v(" "),t("div",{staticClass:"flex items-center gap-2"},[e.$can("pmp_files.upload")?t("button",{staticClass:"text-xs text-blue-600 hover:underline",on:{click:function(t){return e.downloadFile(r)}}},[e._v("\n              Ներբեռնել\n            ")]):e._e(),e._v(" "),e.$can("pmp_files.view")?t("a",{staticClass:"text-xs text-gray-700 hover:underline",attrs:{href:e.filePreviewUrl(r.path,r.original_name),target:"_blank",rel:"noopener"}},[e._v("\n              Բացել\n            ")]):e._e()])])])}),0)]):e._e(),e._v(" "),e.images.length&&e.$can("pmp_files.view")?t("section",[t("h4",{staticClass:"text-sm font-semibold mb-2"},[e._v("Նկարներ")]),e._v(" "),t("div",{staticClass:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3"},e._l(e.images,function(r){return t("a",{key:e.keyOf(r),staticClass:"block rounded-lg overflow-hidden border border-gray-200 dark:border-gray-800 group",attrs:{href:e.filePreviewUrl(r.path,r.original_name),target:"_blank",rel:"noopener"}},[t("img",{staticClass:"w-full h-40 object-cover group-hover:scale-[1.02] transition",attrs:{src:e.filePreviewUrl(r.path,r.original_name)}}),e._v(" "),t("div",{staticClass:"p-2 text-[11px] truncate"},[e._v(e._s(r.original_name))])])}),0)]):e._e(),e._v(" "),e.cadFiles.length?t("section",[t("h4",{staticClass:"text-sm font-semibold mb-2"},[e._v("CAD Files")]),e._v(" "),t("div",{staticClass:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"},e._l(e.cadFiles,function(r){return t("div",{key:e.keyOf(r),staticClass:"rounded-xl border border-gray-200 dark:border-gray-800 p-4 bg-white dark:bg-gray-900"},[t("div",{staticClass:"text-sm font-medium truncate mb-3"},[e._v("\n          "+e._s(r.original_name)+"\n        ")]),e._v(" "),e.$can("pmp_files.upload")?t("button",{staticClass:"w-full h-10 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 transition",on:{click:function(t){return e.downloadFile(r)}}},[e._v("\n          Ներբեռնել\n        ")]):e._e()])}),0)]):e._e(),e._v(" "),e.showDxf?t("DxfViewerModal",{attrs:{"dxf-url":e.encodedDxfPath,"file-name":e.currentDxfName},on:{close:function(t){e.showDxf=!1}}}):e._e(),e._v(" "),t("notifications")],1)},[],!1,null,null,null);t.default=component.exports}}]);