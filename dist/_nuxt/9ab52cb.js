(window.webpackJsonp=window.webpackJsonp||[]).push([[30],{616:function(e,t,n){"use strict";n.r(t);var r=n(1),o=(n(9),n(33),n(49),n(17),n(403),n(582),n(27),n(8),n(598),n(30),n(570)),l=n(589),c=n(597),d=n(645),h={name:"DxfCanvasViewer",props:{dxfUrl:{type:String,required:!0},fileMeta:{type:Object,default:null},showLaserInfo:{type:Boolean,default:!0}},data:function(){return{scene:null,camera:null,renderer:null,controls:null,dxfGroup:null,error:null,raf:null,laserLengthMm:0}},computed:{laserLengthMmRounded:function(){return this.laserLengthMm?Number(this.laserLengthMm.toFixed(1)):0},materialInfo:function(){if(!this.fileMeta)return"";var e=this.fileMeta.material_type||this.fileMeta.material||this.fileMeta.materialType||"",th=this.fileMeta.thickness||"";return e&&th?"".concat(e," (").concat(th,")"):e||th||""}},watch:{dxfUrl:function(){this.loadDxfFile()}},mounted:function(){this.initThree(),this.loadDxfFile(),window.addEventListener("resize",this.onResize)},beforeDestroy:function(){window.removeEventListener("resize",this.onResize),this.cleanupThree()},methods:{initThree:function(){var e=this,canvas=this.$refs.canvas,t=canvas.clientWidth||960,n=canvas.clientHeight||600;this.scene=new o.ld,this.camera=new o.lc(60,t/n,.1,5e4),this.camera.position.set(0,0,500),this.renderer=new l.a({canvas:canvas,antialias:!0}),this.renderer.setClearColor(16777215,1),this.renderer.setPixelRatio(window.devicePixelRatio||1),this.renderer.setSize(t,n,!1),this.controls=new d.a(this.camera,canvas),this.controls.enableDamping=!0,this.controls.dampingFactor=.08,this.scene.add(new o.i(16777215,1));var r=function(){e.raf=requestAnimationFrame(r),e.controls.update(),e.renderer.render(e.scene,e.camera)};r()},onResize:function(){if(this.renderer&&this.camera){var canvas=this.$refs.canvas,e=canvas.clientWidth||960,t=canvas.clientHeight||600;this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t,!1)}},cleanupThree:function(){var e,t,n,r;this.raf&&cancelAnimationFrame(this.raf),null===(e=this.controls)||void 0===e||null===(t=e.dispose)||void 0===t||t.call(e),null===(n=this.renderer)||void 0===n||null===(r=n.dispose)||void 0===r||r.call(n),this.dxfGroup&&this.dxfGroup.traverse(function(e){var t,n,r,o;null===(t=e.geometry)||void 0===t||null===(n=t.dispose)||void 0===n||n.call(t),Array.isArray(e.material)?e.material.forEach(function(e){var t;return null==e||null===(t=e.dispose)||void 0===t?void 0:t.call(e)}):null===(r=e.material)||void 0===r||null===(o=r.dispose)||void 0===o||o.call(r)}),this.scene=this.camera=this.renderer=this.controls=this.dxfGroup=null,this.laserLengthMm=0},loadDxfFile:function(){var e=this;return Object(r.a)(regeneratorRuntime.mark(function t(){var n,data,r,o,l,c;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,e.error=null,e.cleanupThree(),e.initThree(),e.laserLengthMm=0,t.next=1,e.$axios.get("/api/factories/getFile/".concat(e.dxfUrl));case 1:if(n=t.sent,data=n.data,200===(r=n.status)){t.next=2;break}throw new Error("HTTP ".concat(r));case 2:o=atob(data.content);try{l=JSON.parse(o),o=null!=l&&l.content?atob(l.content):o}catch(e){}e.parseDxf(o),t.next=4;break;case 3:t.prev=3,c=t.catch(0),console.error(c),e.error=c.message||"Չհաջողվեց բեռնել DXF-ը",e.$notify({text:e.error,type:"error",duration:4e3});case 4:case"end":return t.stop()}},t,null,[[0,3]])}))()},parseDxf:function(e){var t=this;try{var n,r=(new c.a).parseSync(e);this.dxfGroup&&this.scene.remove(this.dxfGroup),this.dxfGroup=new o.hb,this.laserLengthMm=0;var l=new o.qb({color:0}),d=new o.qb({color:1982639}),h=function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t.dxfGroup,c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;try{var f,v;if("LINE"===e.type){var m,x,w=(null===(m=e.vertices)||void 0===m?void 0:m[0])||e.start,y=(null===(x=e.vertices)||void 0===x?void 0:x[1])||e.end;if(!w||!y)return;var M=new o.Jd(w.x,w.y,0),L=new o.Jd(y.x,y.y,0),P=(new o.p).setFromPoints([M,L]);n.add(new o.pb(P,l)),t.laserLengthMm+=M.distanceTo(L)*c}else if("LWPOLYLINE"===e.type||"POLYLINE"===e.type){if(!e.vertices||e.vertices.length<2)return;var _=e.vertices.map(function(e){return new o.Jd(e.x,e.y,0)});(e.closed||e.shape)&&_.push(_[0]);var F=(new o.p).setFromPoints(_);n.add(new o.pb(F,l));for(var i=1;i<_.length;i++)t.laserLengthMm+=_[i].distanceTo(_[i-1])*c}else if("CIRCLE"===e.type){var R=new o.t(e.radius,64);R.translate(e.center.x,e.center.y,0);var T=new o.R(R);n.add(new o.rb(T,l)),t.laserLengthMm+=2*Math.PI*e.radius*c}else if("ARC"===e.type){var C=o.Bb.degToRad(e.startAngle),E=o.Bb.degToRad(e.endAngle),k=new o.j(e.center.x,e.center.y,e.radius,C,E,E<C).getPoints(64).map(function(p){return new o.Jd(p.x,p.y,0)}),I=(new o.p).setFromPoints(k);n.add(new o.pb(I,l));for(var S=1;S<k.length;S++)t.laserLengthMm+=k[S].distanceTo(k[S-1])*c}else if("SPLINE"===e.type&&(null===(f=e.controlPoints)||void 0===f?void 0:f.length)>=2){var D=e.controlPoints.map(function(p){return new o.Jd(p.x,p.y,0)}),G=new o.r(D);G.tension=.5;var z=G.getPoints(100),J=(new o.p).setFromPoints(z);n.add(new o.pb(J,d));for(var A=1;A<z.length;A++)t.laserLengthMm+=z[A].distanceTo(z[A-1])*c}else if("ELLIPSE"===e.type){var j=new o.S(e.center.x,e.center.y,e.majorRadius,e.minorRadius,e.startAngle||0,e.endAngle||2*Math.PI,!1,0).getPoints(100).map(function(p){return new o.Jd(p.x,p.y,0)}),H=(new o.p).setFromPoints(j);n.add(new o.pb(H,l));for(var N=1;N<j.length;N++)t.laserLengthMm+=j[N].distanceTo(j[N-1])*c}else if("INSERT"===e.type&&null!==(v=r.blocks)&&void 0!==v&&v[e.name]){var O,$,B,X=r.blocks[e.name],U=new o.hb,V=(null===(O=e.scale)||void 0===O?void 0:O.x)||e.xScale||1,W=(null===($=e.scale)||void 0===$?void 0:$.y)||e.yScale||1,s=(V+W)/2||1;null===(B=X.entities)||void 0===B||B.forEach(function(e){return h(e,U,c*s)}),e.position&&U.position.set(e.position.x,e.position.y,0),e.rotation&&(U.rotation.z=o.Bb.degToRad(e.rotation)),U.scale.set(V||1,W||1,1),n.add(U)}}catch(t){console.warn("Entity error:",e.type,t)}};if(null===(n=r.entities)||void 0===n||n.forEach(function(e){return h(e)}),0===this.dxfGroup.children.length){var f,v,m,x=(null===(f=r.blocks)||void 0===f?void 0:f["*Model_Space"])||(null===(v=r.blocks)||void 0===v?void 0:v["*Paper_Space"]);null==x||null===(m=x.entities)||void 0===m||m.forEach(function(e){return h(e)})}if(this.scene.add(this.dxfGroup),this.dxfGroup.children.length>0){var w=(new o.m).setFromObject(this.dxfGroup),y=w.getCenter(new o.Jd),M=w.getSize(new o.Jd);this.dxfGroup.position.sub(y);var L=(Math.max(M.x,M.y)||100)/(2*Math.tan(this.camera.fov*Math.PI/180/2))*1.4;this.camera.position.set(0,0,Math.max(L,50)),this.camera.lookAt(0,0,0),this.controls.target.set(0,0,0),this.controls.update()}else this.error="DXF-ը դատարկ է կամ չի պարունակում գծագրեր"}catch(e){console.error("DXF parse error:",e),this.error=e.message||"DXF-ը չի կարող մշակվել",this.$notify({text:this.error,type:"error",duration:5e3})}}}},f=h,v=n(32),component=Object(v.a)(f,function(){var e=this,t=e._self._c;return t("div",{staticClass:"w-full h-full relative"},[t("button",{staticClass:"absolute top-3 right-3 flex items-center justify-center rounded-lg text-sm transition",on:{click:function(t){return e.$emit("close")}}},[t("svg",{staticClass:"hover:animate-pulse",attrs:{xmlns:"http://www.w3.org/2000/svg",x:"0px",y:"0px",width:"30",height:"30",viewBox:"0 0 48 48"}},[t("path",{attrs:{fill:"#F44336",d:"M21.5 4.5H26.501V43.5H21.5z",transform:"rotate(45.001 24 24)"}}),e._v(" "),t("path",{attrs:{fill:"#F44336",d:"M21.5 4.5H26.5V43.501H21.5z",transform:"rotate(135.008 24 24)"}})])]),e._v(" "),t("canvas",{ref:"canvas",staticClass:"w-full h-full block"}),e._v(" "),e.showLaserInfo&&e.laserLengthMmRounded>0?t("div",{staticClass:"absolute left-2 top-2 px-3 py-1.5 rounded-lg bg-black/70 text-[11px] text-white backdrop-blur-sm flex flex-col gap-0.5 max-w-[280px]"},[e.materialInfo?t("div",{staticClass:"font-medium truncate"},[e._v("\n      "+e._s(e.materialInfo)+"\n    ")]):e._e(),e._v(" "),t("div",{staticClass:"opacity-80"},[e._v("\n      Գծամետրում՝\n      "),t("span",{staticClass:"font-semibold"},[e._v(e._s(e.laserLengthMmRounded))]),e._v("\n      մմ\n    ")])]):e._e(),e._v(" "),e.error?t("div",{staticClass:"absolute left-2 bottom-2 px-2 py-1 text-xs rounded bg-red-600 text-white"},[e._v("\n    DXF սխալ — "+e._s(e.error)+"\n  ")]):e._e(),e._v(" "),t("notifications")],1)},[],!1,null,null,null);t.default=component.exports}}]);